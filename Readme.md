# 股票预测强化学习框架

基于Transformer架构的股票预测强化学习框架，支持在线/离线数据获取、模型训练、评估与交易信号生成。

## 功能特性

- **双模式数据获取**
  - 在线模式通过AKShare实时获取数据
  - 离线模式读取本地历史数据文件
- **深度Transformer模型**
  - 多层Transformer Encoder结构
  - 自适应特征嵌入与序列建模
- **滚动窗口标准化**
  - 动态特征标准化处理
  - 适应市场分布变化
- **强化学习框架**
  - 每日增量训练机制
  - 自动保存最优模型参数
- **高效数据预处理**
  - 多进程并行数据加载
  - 内存缓存优化机制

## 环境依赖

- Python 3.8+
- PyTorch 1.12+
- pandas 1.4+
- akshare 1.3+
- numpy 1.22+

安装依赖：
```bash
pip install torch pandas akshare numpy
```

## 使用方法

### 快速启动
```python
python main.py --start_date 20230101 --online
```

### 参数说明
| 参数           | 类型   | 默认值    | 说明                      |
|----------------|--------|-----------|---------------------------|
| start_date     | str    | 20000101  | 起始日期(YYYYMMDD)        |
| continue_train | bool   | False     | 是否从上次保存点继续训练  |
| online         | bool   | True      | 使用在线数据获取模式      |

### 训练控制
- 按`Ctrl+C`可安全中断训练，自动保存当前模型
- 每日训练完成后自动生成Top10股票推荐
- 模型参数自动保存到`model.pth`

## 配置参数

```python
# 模型架构
HISTORY_WINDOW = 30   # 历史窗口天数
EMBEDDING_DIM = 64    # 特征嵌入维度
NUM_HEADS = 4         # 多头注意力头数
NUM_LAYERS = 3        # Transformer层数

# 训练参数
BATCH_SIZE = 512      # 训练批大小
LEARNING_RATE = 1e-4  # 初始学习率
GAMMA = 0.99         # 折扣因子

# 特征列(需与数据文件匹配)
FEATURE_COLS = ['开盘', '收盘', '最高', '最低', '成交量', '成交额', '振幅', '换手率']
```

## 数据规范

### 在线模式
- 自动通过AKShare接口获取数据
- 需要稳定的网络连接

### 离线模式
1. 在项目根目录创建`data`文件夹
2. 按`股票代码.csv`格式存放数据文件
3. CSV文件需包含以下字段：
   - 日期 (YYYY-MM-DD)
   - 开盘价
   - 收盘价
   - 最高价
   - 最低价
   - 成交量
   - 成交额
   - 振幅
   - 换手率
   - 涨跌幅

示例文件结构：
```
project/
├── data/
│   ├── 000001.csv
│   └── 600000.csv
├── main.py
└── model.pth
```

## 常见问题

### 数据获取失败
- 在线模式：检查网络连接，确认AKShare版本
- 离线模式：验证数据文件路径及格式

### 内存不足
- 减小`BATCH_SIZE`
- 缩短`HISTORY_WINDOW`
- 使用`del self.data_cache`手动清理缓存

### 日期不存在
- 自动跳转到最近的有效交易日
- 确保数据包含指定日期范围的交易数据

## 性能优化

1. **GPU加速**：自动检测CUDA设备，建议使用NVIDIA显卡
2. **多进程加载**：根据CPU核心数自动优化数据加载
3. **梯度裁剪**：防止梯度爆炸，提升训练稳定性
4. **日志标准化**：对成交类数据进行对数变换

## 注意事项

- 首次在线运行需下载全量历史数据，耗时较长
- 建议交易日收盘后执行当日训练
- 模型预测结果需结合实际市场情况判断

> 本系统为研究用途，不构成投资建议。金融市场存在风险，请谨慎决策。

### 智能体工作流示例
```bash
python agent_workflow.py 000001 --start 20230101
```
此脚本演示从数据抓取、价格趋势预测到使用LLM生成简易投资观点的流程。生成的内容仅供研究参考。

### 交互式前端
```bash
uvicorn web_app:app --reload
```
启动后在浏览器访问 `http://localhost:8000` 输入股票代码即可在线获取趋势图、预测结果与简易投资观点。请注意，所有内容仅供研究参考，不构成投资建议。

